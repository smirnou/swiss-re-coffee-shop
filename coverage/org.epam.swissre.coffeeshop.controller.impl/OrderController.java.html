<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrderController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Swiss Re Coffee Shop</a> &gt; <a href="index.source.html" class="el_package">org.epam.swissre.coffeeshop.controller.impl</a> &gt; <span class="el_source">OrderController.java</span></div><h1>OrderController.java</h1><pre class="source lang-java linenums">package org.epam.swissre.coffeeshop.controller.impl;

import org.epam.swissre.coffeeshop.controller.IOrderController;
import org.epam.swissre.coffeeshop.enums.OrderStatus;
import org.epam.swissre.coffeeshop.model.Order;
import org.epam.swissre.coffeeshop.model.Product;
import org.epam.swissre.coffeeshop.receipt.ReceiptPresenter;
import org.epam.swissre.coffeeshop.receipt.ReceiptRow;
import org.epam.swissre.coffeeshop.service.IOrderService;
import org.epam.swissre.coffeeshop.service.IOrderStorage;
import org.epam.swissre.coffeeshop.service.IPaymentService;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.stream.Stream;

/**
 * The OrderController class orchestrates the processing of orders, calculation of payments,
 * and the presentation of receipts. It serves as a mediator between the service layer (order and
 * payment services) and the presentation layer (receipt presenter).
 */
public class OrderController implements IOrderController {
    private final IOrderService orderService;
    private final IOrderStorage orderStorage;
    private final IPaymentService paymentService;
    private final ReceiptPresenter receiptPresenter;

    /**
     * Constructs an OrderController with specified service and presenter components.
     *
     * @param orderService the service responsible for managing order details
     * @param orderStorage the service responsible for storing order data details
     * @param paymentService the service responsible for payment calculations
     * @param receiptPresenter the component responsible for presenting the receipt
     */
    public OrderController(IOrderService orderService,
                           IOrderStorage orderStorage,
                           IPaymentService paymentService,
<span class="fc" id="L41">                           ReceiptPresenter receiptPresenter) {</span>
<span class="fc" id="L42">        this.orderService = orderService;</span>
<span class="fc" id="L43">        this.orderStorage = orderStorage;</span>
<span class="fc" id="L44">        this.paymentService = paymentService;</span>
<span class="fc" id="L45">        this.receiptPresenter = receiptPresenter;</span>
<span class="fc" id="L46">    }</span>

    /**
     * Processes a list of products as an order. This method manages the complete order flow:
     * calculating the subtotal, final total (after taxes and discounts), and presenting the receipt.
     *
     * @param newProducts a list of products to be processed as an order
     */
    @Override
    public void processOrder(List&lt;Product&gt; newProducts) {
<span class="fc" id="L56">        List&lt;Product&gt; alreadyPaidProducts = new ArrayList&lt;&gt;();</span>
        try {
<span class="fc" id="L58">            alreadyPaidProducts = orderStorage.retrieveOrders().stream()</span>
<span class="fc" id="L59">                    .filter(Objects::nonNull) // Ensure that the order is not null</span>
<span class="pc bnc" id="L60" title="All 2 branches missed.">                    .flatMap(order -&gt; order.getProducts() != null ? order.getProducts().stream() : Stream.empty()).toList(); // Safeguard against null product lists</span>
<span class="nc" id="L61">        } catch (IOException e) {</span>
<span class="nc" id="L62">            System.err.println(&quot;Failed to load paid orders. &quot; + e.getMessage());</span>
<span class="fc" id="L63">        }</span>

        // Process the order through the OrderService to create an Order object
<span class="fc" id="L66">        Order order = orderService.processOrder(newProducts, alreadyPaidProducts);</span>

        // Process the payment through the PaymentService
<span class="fc" id="L69">        paymentService.processPayment(order);</span>

        try {
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">            if (order.getStatus() == OrderStatus.PAID) {</span>
<span class="fc" id="L73">                orderStorage.storeOrders(List.of(order));</span>
            }
<span class="nc" id="L75">        } catch (IOException e) {</span>
<span class="nc" id="L76">            System.err.println(&quot;Failed to store paid order. &quot; + e.getMessage());</span>
<span class="fc" id="L77">        }</span>

<span class="fc" id="L79">        makeReceipt(order); // output to CLI</span>
<span class="fc" id="L80">    }</span>

    private void makeReceipt(Order order) {
        // Use the ReceiptPresenter to add each product line item to the receipt
<span class="fc bfc" id="L84" title="All 2 branches covered.">        for (Product product : order.getProducts()) {</span>
<span class="fc" id="L85">            receiptPresenter.addReceiptRow(new ReceiptRow(product.getName(), product.getPrice()));</span>
<span class="fc" id="L86">        }</span>

<span class="fc" id="L88">        receiptPresenter.setTotalCost(order.getTotalCost());</span>
<span class="fc" id="L89">        receiptPresenter.setTotalDiscount(order.getTotalDiscount());</span>

        // Finally, present the receipt
<span class="fc" id="L92">        receiptPresenter.presentReceipt();</span>
<span class="fc" id="L93">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>